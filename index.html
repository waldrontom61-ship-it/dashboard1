<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>YMCA Dashboard with Admin Panel</title>
    <style>
        /* --- (Your original CSS preserved exactly) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { box-sizing: border-box; }

        .main-layout { display:flex; height:100vh; background:black; font-family: system-ui, -apple-system, sans-serif; }
        .content-area { width:70%; background:#111827; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden; }
        .sidebar-overlay { width:30%; height:100vh; background: linear-gradient(to bottom, #dc2626, #991b1b); color:white; position:relative; overflow:hidden; display:flex; flex-direction:column; }
        .sidebar-footer { background:#7f1d1d; padding:1rem; display:flex; justify-content:space-between; align-items:center; border-top:1px solid rgba(255,255,255,0.2); }
        .footer-time { font-size:0.875rem; font-weight:600; }
        .footer-date { font-size:0.75rem; opacity:0.8; margin-top:0.25rem; }
        .footer-weather { display:flex; align-items:center; gap:0.5rem; font-size:0.875rem; }
        .footer-weather-icon { font-size:1.25rem; }

        .sidebar-header { background: rgba(0,0,0,0.3); padding:1rem; text-align:center; }
        .sidebar-logo { max-width:200px; height:auto; margin-bottom:0.5rem; }
        .sidebar-title { font-size:1.5rem; font-weight:bold; margin-bottom:0.5rem; }

        .content-section { padding:1rem; flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .classes-section { flex:1; overflow:hidden; margin-bottom:1rem; display:flex; flex-direction:column; }
        .classes-container { flex:1; overflow:hidden; }

        .section-title { font-size:1rem; font-weight:bold; margin-bottom:0.75rem; border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:0.25rem; text-align:center; }
        .info-card { background: rgba(255,255,255,0.2); border-radius:0.5rem; padding:0.5rem; margin-bottom:0.5rem; backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.1); }
        .card-title { font-weight:600; margin-bottom:0.125rem; font-size:0.95rem; }
        .card-subtitle { font-size:0.85rem; opacity:0.9; }
        .card-meta { font-size:0.725rem; opacity:0.7; margin-top:0.125rem; }

        .cancelled-class { background: rgba(239,68,68,0.3) !important; border:2px solid #ef4444 !important; position:relative; }
        .cancelled-badge { background:#ef4444; color:white; padding:0.25rem 0.5rem; border-radius:0.25rem; font-size:0.75rem; font-weight:bold; margin-top:0.5rem; display:inline-block; }

        .weather-display { display:flex; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.15); border-radius:0.75rem; padding:1rem; margin-bottom:1rem; }
        .weather-icon { font-size:2rem; }
        .weather-temp { font-size:1.5rem; font-weight:bold; }
        .weather-condition { font-size:0.875rem; opacity:0.9; }

        .announcement-container { position:relative; height:80px; overflow:hidden; border-radius:0.5rem; }
        .announcement-slide { position:absolute; top:0; left:0; width:100%; padding:0.75rem; border-radius:0.5rem; backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.1); opacity:0; transform: translateY(20px); transition: all 0.5s ease-in-out; }
        .announcement-slide.active { opacity:1; transform: translateY(0); }
        .urgent-announcement { background: linear-gradient(135deg,#dc2626,#991b1b); border:2px solid #ef4444; box-shadow: 0 0 15px rgba(220,38,38,0.3); }
        .warning-announcement { background: linear-gradient(135deg,#f59e0b,#d97706); border:2px solid #fbbf24; box-shadow: 0 0 15px rgba(245,158,11,0.3); }
        .good-announcement { background: linear-gradient(135deg,#059669,#047857); border:2px solid #10b981; box-shadow: 0 0 15px rgba(5,150,105,0.3); }

        .media-container { position:relative; width:100%; height:100%; overflow:hidden; }
        .media-slide { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; transition: opacity 1s ease-in-out; display:flex; align-items:center; justify-content:center; }
        .media-slide.active { opacity:1; }
        .media-slide img, .media-slide video { width:100%; height:100%; object-fit:cover; }

        .admin-toggle { position:fixed; top:1rem; right:1rem; background: rgba(0,0,0,0.1); color: rgba(255,255,255,0.3); border:none; padding:0.5rem; border-radius:50%; cursor:pointer; z-index:100; font-size:1rem; backdrop-filter: blur(10px); transition: all 0.3s ease; width:40px; height:40px; display:flex; align-items:center; justify-content:center;}
        .admin-toggle:hover { background: rgba(0,0,0,0.3); color: rgba(255,255,255,0.7); transform: rotate(90deg); }

        .admin-panel { position:fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg,#1f2937,#111827); z-index:200; display:none; overflow-y:auto; }
        .admin-content { background: linear-gradient(135deg,#1e293b,#0f172a); margin:1rem; padding:2rem; border-radius:1rem; max-width:70rem; margin:1rem auto; box-shadow: 0 25px 50px rgba(0,0,0,0.7); color:white; border:2px solid #334155; font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; }
        .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; padding-bottom:1.5rem; border-bottom:3px solid #dc2626; background: linear-gradient(135deg,#dc2626,#b91c1c); margin:-2rem -2rem 2rem -2rem; padding:2rem 2rem 1.5rem 2rem; border-radius:1rem 1rem 0 0; box-shadow: 0 4px 20px rgba(220,38,38,0.3); }
        .admin-title { font-size:2.5rem; font-weight:800; color:white; margin:0; text-shadow: 0 2px 4px rgba(0,0,0,0.3); letter-spacing: -0.025em; }

        .admin-tabs { display:flex; gap:0.5rem; margin-bottom:2rem; background: rgba(30,41,59,0.5); padding:0.5rem; border-radius:0.75rem; border:1px solid #475569; }
        .admin-tab { padding:1rem 2rem; background:transparent; border:none; border-radius:0.5rem; cursor:pointer; font-weight:600; font-size:1rem; color:#94a3b8; transition: all 0.3s ease; font-family:inherit; }
        .admin-tab.active { background: linear-gradient(135deg,#dc2626,#b91c1c); color:white; box-shadow: 0 4px 12px rgba(220,38,38,0.4); transform: translateY(-1px); }
        .admin-tab:hover { background: rgba(220,38,38,0.1); color:#f1f5f9; }

        .admin-section { display:none; }
        .admin-section.active { display:block; }
        .form-group { margin-bottom:1.5rem; }
        .form-label { display:block; font-weight:700; color:#f8fafc; margin-bottom:0.75rem; font-size:1rem; letter-spacing:0.025em; }
        .form-input, .form-select { width:100%; padding:1rem 1.25rem; border:2px solid #475569; border-radius:0.75rem; font-size:1rem; font-weight:500; transition: all 0.3s ease; box-sizing:border-box; background:#334155; color:#f8fafc; font-family:inherit; }
        .form-input:focus, .form-select:focus { outline:none; border-color:#dc2626; background:#475569; box-shadow: 0 0 0 3px rgba(220,38,38,0.1); }
        .form-input::placeholder { color:#94a3b8; font-weight:400; }

        .btn { padding:1rem 2rem; border:none; border-radius:0.75rem; font-weight:700; font-size:1rem; cursor:pointer; transition: all 0.3s ease; margin-right:0.75rem; margin-bottom:0.5rem; font-family:inherit; letter-spacing:0.025em; }
        .btn-primary { background: linear-gradient(135deg,#dc2626,#b91c1c); color:white; border:2px solid #dc2626; box-shadow: 0 4px 12px rgba(220,38,38,0.3); }
        .btn-secondary { background: linear-gradient(135deg,#475569,#334155); color:white; border:2px solid #475569; box-shadow: 0 4px 12px rgba(71,85,105,0.3); }
        .btn-danger { background: linear-gradient(135deg,#ef4444,#dc2626); color:white; border:2px solid #ef4444; box-shadow: 0 4px 12px rgba(239,68,68,0.3); }

        .data-table { width:100%; border-collapse:collapse; margin-top:1.5rem; background:#1e293b; border-radius:1rem; overflow:hidden; border:2px solid #334155; box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .data-table th, .data-table td { padding:1.25rem 1rem; text-align:left; border-bottom:1px solid #334155; font-weight:500; }
        .data-table th { background: linear-gradient(135deg,#dc2626,#b91c1c); font-weight:700; color:white; font-size:1rem; letter-spacing:0.025em; text-transform:uppercase; }
        .data-table td { color:#f1f5f9; background:#334155; }
        .data-table tr:hover td { background:#475569; }

        .severity-badge { padding:0.25rem 0.75rem; border-radius:9999px; font-size:0.75rem; font-weight:600; text-transform:uppercase; }
        .severity-urgent { background:#fee2e2; color:#991b1b; }
        .severity-warning { background:#fef3c7; color:#92400e; }
        .severity-good { background:#d1fae5; color:#065f46; }

        .close-btn { background: rgba(255,255,255,0.1); border:2px solid rgba(255,255,255,0.3); font-size:1.5rem; cursor:pointer; color:white; padding:0.75rem; border-radius:0.5rem; transition: all 0.3s ease; font-weight:bold; }
        .close-btn:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg) scale(1.1); border-color: rgba(255,255,255,0.5); }

        .success-message { background: linear-gradient(135deg,#10b981,#059669); color:white; padding:1.25rem; border-radius:0.75rem; margin-bottom:1.5rem; border:2px solid #34d399; font-weight:600; box-shadow: 0 4px 12px rgba(16,185,129,0.3); }
        .admin-section h3 { color:#f8fafc; margin-bottom:1.5rem; font-size:1.75rem; font-weight:800; letter-spacing:-0.025em; border-bottom:3px solid #dc2626; padding-bottom:0.75rem; }
        .demo-content { color:white; text-align:center; }
        .demo-title { font-size:3rem; font-weight:bold; margin-bottom:1rem; }
        .demo-subtitle { font-size:1.25rem; opacity:0.75; }
    </style>
</head>
<body>
    <!-- Admin Toggle -->
    <button class="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è</button>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Content Area (70%) -->
        <div class="content-area">
            <div class="media-container" id="media-container">
                <!-- Media slides will be populated here -->
            </div>
        </div>

        <!-- Sidebar Overlay (30%) -->
        <div class="sidebar-overlay">
            <!-- Header -->
            <div class="sidebar-header">
                <img src="https://ymcasaskatoon.org/wp-content/uploads/2022/06/Shine-On_Horiz_white_RGB_Saskatoon-scaled.png"
                     alt="YMCA of Saskatoon Logo"
                     class="sidebar-logo"
                     onerror="this.style.display='none'; document.getElementById('gymNameDisplay').style.display='block';">
                <h2 class="sidebar-title" id="gymNameDisplay" style="display:none;">YMCA of Saskatoon</h2>
            </div>

            <!-- Content Sections -->
            <div class="content-section">
                <!-- Classes Section -->
                <div class="classes-section">
                    <h3 class="section-title">üïê TODAY'S CLASSES</h3>
                    <div id="classes-container">
                        <!-- Classes will be populated here -->
                    </div>
                </div>

                <!-- Announcements -->
                <div class="announcements-section">
                    <h3 class="section-title">üì¢ ANNOUNCEMENTS</h3>
                    <div class="announcement-container" id="announcement-container">
                        <!-- Announcements will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="sidebar-footer">
                <div>
                    <div class="footer-time" id="currentTime">12:34 PM</div>
                    <div class="footer-date" id="currentDate">Monday, Dec 16</div>
                </div>
                <div class="footer-weather" id="weather-display">
                    <span class="footer-weather-icon" id="weather-icon">‚õÖ</span>
                    <span id="weather-temp">--¬∞C</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="admin-content">
            <div class="admin-header">
                <h1 class="admin-title">üèãÔ∏è YMCA Dashboard Admin</h1>
                <button class="close-btn" onclick="toggleAdmin()">‚úï</button>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchTab('classes')">Classes</button>
                <button class="admin-tab" onclick="switchTab('announcements')">Announcements</button>
                <button class="admin-tab" onclick="switchTab('media')">Media</button>
                <button class="admin-tab" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Classes Section -->
            <div class="admin-section active" id="classes-section">
                <h3>Manage Classes</h3>

                <form id="class-form" onsubmit="addClass(event)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label class="form-label">Class Name</label>
                            <input type="text" class="form-input" id="className" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time</label>
                            <input type="text" class="form-input" id="classTime" placeholder="6:00 PM" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-input" id="classLocation" placeholder="Studio A" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Instructor</label>
                            <input type="text" class="form-input" id="classInstructor" placeholder="Sarah" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;">
                            <input type="checkbox" id="classCancelled" style="width:auto;">
                            <span class="form-label" style="margin:0;">Mark as Cancelled</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary">Add Class</button>
                    <button type="button" class="btn btn-secondary" onclick="clearClassForm()">Clear</button>
                </form>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Class Name</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Instructor</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="classes-table"></tbody>
                </table>
            </div>

            <!-- Announcements Section -->
            <div class="admin-section" id="announcements-section">
                <h3>Manage Announcements</h3>

                <form id="announcement-form" onsubmit="addAnnouncement(event)">
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="announcementTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <input type="text" class="form-input" id="announcementMessage" required>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                        <div class="form-group">
                            <label class="form-label">Details</label>
                            <input type="text" class="form-input" id="announcementDetails" placeholder="Additional information">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity</label>
                            <select class="form-select" id="announcementSeverity" required>
                                <option value="good">Good News (Green)</option>
                                <option value="warning">Warning (Yellow)</option>
                                <option value="urgent">Urgent (Red)</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Announcement</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAnnouncementForm()">Clear</button>
                </form>

                <table class="data-table">
                    <thead>
                        <tr><th>Title</th><th>Message</th><th>Severity</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="announcements-table"></tbody>
                </table>
            </div>

            <!-- Media Section -->
            <div class="admin-section" id="media-section">
                <h3>Manage Media</h3>

                <form id="media-form" onsubmit="addMedia(event)">
                    <div class="form-group">
                        <label class="form-label">Media URL</label>
                        <input type="url" class="form-input" id="imageUrl" placeholder="https://example.com/image.jpg" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="mediaType">
                            <option value="image">Image</option>
                            <option value="video">Video</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (seconds, optional for video)</label>
                        <input type="number" class="form-input" id="mediaDuration" placeholder="Duration in seconds">
                    </div>

                    <button type="submit" class="btn btn-primary">Add Media</button>
                    <button type="button" class="btn btn-secondary" onclick="clearMediaForm()">Clear</button>
                </form>

                <table class="data-table">
                    <thead><tr><th>Type</th><th>Source</th><th>Actions</th></tr></thead>
                    <tbody id="media-table"></tbody>
                </table>
            </div>

            <!-- Settings Section -->
            <div class="admin-section" id="settings-section">
                <h3>Dashboard Settings</h3>

                <div class="form-group">
                    <label class="form-label">Gym Name</label>
                    <input type="text" class="form-input" id="gymName" value="YMCA of Saskatoon">
                </div>

                <div class="form-group">
                    <label class="form-label">Announcement Rotation Speed (seconds)</label>
                    <input type="number" class="form-input" id="rotationSpeed" value="4" min="2" max="30">
                </div>

                <div class="form-group">
                    <label class="form-label">Media Rotation Speed (seconds)</label>
                    <input type="number" class="form-input" id="mediaRotationSpeed" value="8" min="3" max="300">
                </div>

                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                <button class="btn btn-danger" onclick="resetData()">Reset All Data</button>
            </div>

            <div id="success-message" style="display:none;" class="success-message">Changes saved successfully!</div>
        </div>
    </div>

    <script>
    /******************************************************************
     * Dashboard script
     * - Loads all data from a separate JSON file (dashboard-data.json)
     * - Renders media (image/video), today's schedule, announcements,
     *   live time/date in Regina (Saskatoon) timezone, weather via Open-Meteo
     * - Admin panel edits are temporary (stored to localStorage only for temp)
     *
     * IMPORTANT: put your JSON (the one you pasted me) in file:
     *   ./dashboard-data.json
     * next to this HTML. The page will fetch that file on load.
     ******************************************************************/

    // Set this to the relative path of your JSON file. Keep it local (./dashboard-data.json)
    const JSON_URL = './dashboard-data.json';

    // Dashboard data object (populated from JSON)
    let dashboardData = {
        settings: { gymName: "YMCA of Saskatoon", rotationSpeed: 4, mediaRotationSpeed: 8 },
        media: [],
        weekly_schedule: {},
        classes: [],
        announcements: []
    };

    let currentAnnouncement = 0;
    let currentMedia = 0;
    let rotationInterval = null;
    let mediaInterval = null;
    let videoTimer = null;

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', initDashboard);

    async function initDashboard() {
        await loadJSONData();
        loadLocalData();            // merge temporary local edits
        renderAll();                // render everything
        startAnnouncementRotation();
        startMediaRotation();
        updateDateTime();
        updateWeather();
        setInterval(updateDateTime, 1000);
        setInterval(updateWeather, 300_000); // 5 minutes
    }

    // ---------- JSON LOADING ----------
    async function loadJSONData() {
        try {
            const res = await fetch(JSON_URL, { cache: "no-store" });
            if (!res.ok) throw new Error('Fetch failed: ' + res.status);
            const json = await res.json();

            // Accept only fields from JSON; do NOT hardcode schedule inside this file.
            dashboardData.settings = { ...dashboardData.settings, ...(json.settings || {}) };
            dashboardData.media = Array.isArray(json.media) ? json.media.slice() : [];
            dashboardData.weekly_schedule = json.weekly_schedule || {};
            dashboardData.classes = Array.isArray(json.classes) ? json.classes.slice() : [];
            dashboardData.announcements = Array.isArray(json.announcements) ? json.announcements.slice() : [];

            // Set UI settings fields (if present)
            const gymNameEl = document.getElementById('gymName');
            const rotationSpeedEl = document.getElementById('rotationSpeed');
            const mediaRotationSpeedEl = document.getElementById('mediaRotationSpeed');
            if (gymNameEl) gymNameEl.value = dashboardData.settings.gymName || '';
            if (rotationSpeedEl) rotationSpeedEl.value = dashboardData.settings.rotationSpeed || 4;
            if (mediaRotationSpeedEl) mediaRotationSpeedEl.value = dashboardData.settings.mediaRotationSpeed || 8;
            const gymDisplay = document.getElementById('gymNameDisplay');
            if (gymDisplay) gymDisplay.textContent = dashboardData.settings.gymName || '';

            console.log('Loaded JSON data from', JSON_URL);
        } catch (err) {
            console.error('Error loading JSON:', err);
            // If JSON fails to load, leave dashboardData as defaults and show a message.
        }
    }

    // ---------- LOCAL STORAGE (temporary edits) ----------
    function loadLocalData() {
        const saved = localStorage.getItem('ymcaDashboardData');
        if (!saved) {
            // If no local edits, populate classes from weekly_schedule for today
            dashboardData.classes = getTodaysClasses();
            return;
        }
        try {
            const parsed = JSON.parse(saved);
            // Merge: today schedule + locally added classes (non-schedule)
            dashboardData.classes = [...getTodaysClasses(), ...(parsed.classes || [])];

            // Append local media & announcements if present
            if (Array.isArray(parsed.media)) dashboardData.media = [...dashboardData.media, ...parsed.media];
            if (Array.isArray(parsed.announcements)) dashboardData.announcements = [...dashboardData.announcements, ...parsed.announcements];
        } catch (e) {
            console.warn('Invalid localStorage data:', e);
            dashboardData.classes = getTodaysClasses();
        }
    }

    function saveLocalData() {
        const payload = {
            classes: dashboardData.classes.filter(c => !c.fromSchedule),
            announcements: dashboardData.announcements.filter(a => !a.permanent),
            media: dashboardData.media.filter(m => !m.permanent)
        };
        localStorage.setItem('ymcaDashboardData', JSON.stringify(payload));
    }

    function resetData() {
        if (!confirm('Are you sure you want to reset temporary data?')) return;
        localStorage.removeItem('ymcaDashboardData');
        location.reload();
    }

    // ---------- TODAY'S CLASSES (Saskatoon/Regina timezone) ----------
    function getTodaysClasses() {
        // Use America/Regina timezone to compute today
        const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Regina' }));
        const weekday = now.toLocaleDateString('en-US', { weekday: 'long' });
        const todaysSchedule = dashboardData.weekly_schedule[weekday] || [];
        return todaysSchedule.map((item, idx) => ({
            id: `schedule_${weekday}_${idx}`,
            name: item.event || '',
            time: item.time || '',
            location: item.location || '',
            instructor: item.instructor || '',
            cancelled: false,
            fromSchedule: true
        }));
    }

    // ---------- DATE / TIME ----------
    function updateDateTime() {
        const now = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Regina' }));
        const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
        const timeString = now.toLocaleTimeString('en-US', timeOptions);
        const dateOptions = { weekday: 'long', month: 'short', day: 'numeric' };
        const dateString = now.toLocaleDateString('en-US', dateOptions);

        document.getElementById('currentTime').textContent = timeString;
        document.getElementById('currentDate').textContent = dateString;
    }

    // ---------- WEATHER (Open-Meteo) ----------
    async function updateWeather() {
        try {
            // Saskatoon coordinates
            const url = 'https://api.open-meteo.com/v1/forecast?latitude=52.1332&longitude=-106.6700&current_weather=true';
            const res = await fetch(url);
            if (!res.ok) throw new Error('Weather fetch failed ' + res.status);
            const data = await res.json();
            if (data && data.current_weather) {
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                document.getElementById('weather-temp').textContent = `${temp}¬∞C`;
                document.getElementById('weather-icon').textContent = getWeatherIcon(code);
            } else {
                throw new Error('No current_weather in response');
            }
        } catch (e) {
            console.warn('Weather error:', e);
            document.getElementById('weather-temp').textContent = '--¬∞C';
            document.getElementById('weather-icon').textContent = '‚õÖ';
        }
    }

    function getWeatherIcon(code) {
        const map = {
            0: '‚òÄÔ∏è', 1:'üå§Ô∏è', 2:'‚õÖ', 3:'‚òÅÔ∏è', 45:'üå´Ô∏è', 48:'üå´Ô∏è',
            51:'üå¶Ô∏è',53:'üå¶Ô∏è',55:'üå¶Ô∏è',56:'üå®Ô∏è',57:'üå®Ô∏è',
            61:'üåßÔ∏è',63:'üåßÔ∏è',65:'üåßÔ∏è',66:'üå®Ô∏è',67:'üå®Ô∏è',
            71:'‚ùÑÔ∏è',73:'‚ùÑÔ∏è',75:'‚ùÑÔ∏è',77:'‚ùÑÔ∏è',
            80:'üå¶Ô∏è',81:'üåßÔ∏è',82:'üåßÔ∏è',85:'üå®Ô∏è',86:'üå®Ô∏è',
            95:'‚õàÔ∏è',96:'‚õàÔ∏è',99:'‚õàÔ∏è'
        };
        return map[code] || '‚õÖ';
    }

    // ---------- RENDERING ----------
    function renderAll() {
        renderMedia();
        renderClasses();
        renderAnnouncements();
        renderAdminTables();
    }

    // MEDIA: supports image and video
    function renderMedia() {
        const container = document.getElementById('media-container');
        container.innerHTML = '';
        if (!Array.isArray(dashboardData.media) || dashboardData.media.length === 0) {
            container.innerHTML = `<div class="demo-content"><div class="demo-title">70% CONTENT AREA</div><div class="demo-subtitle">Main media/image content goes here</div><div style="font-size:4rem;margin-top:2rem;">üñºÔ∏è</div></div>`;
            return;
        }

        dashboardData.media.forEach((m, idx) => {
            const slide = document.createElement('div');
            slide.className = 'media-slide' + (idx === 0 ? ' active' : '');
            slide.dataset.index = idx;
            // handle video or image
            if (m.type === 'video') {
                // create video element (autoplay muted loop handled by rotation logic)
                const video = document.createElement('video');
                video.src = m.src;
                video.setAttribute('playsinline', '');
                video.muted = true;
                video.preload = 'metadata';
                video.style.width = '100%';
                video.style.height = '100%';
                video.style.objectFit = 'cover';
                slide.appendChild(video);
            } else {
                const img = document.createElement('img');
                img.src = m.src;
                img.alt = 'Media';
                img.onerror = () => img.style.display = 'none';
                slide.appendChild(img);
            }
            container.appendChild(slide);
        });
    }

    function startMediaRotation() {
        clearInterval(mediaInterval);
        clearTimeout(videoTimer);

        const slides = Array.from(document.querySelectorAll('.media-slide'));
        if (!slides || slides.length === 0) return;

        // Make sure only the current one is active
        slides.forEach((s, i) => s.classList.toggle('active', i === currentMedia));

        // If only one slide -> if it's video, play it, else nothing to rotate
        if (slides.length === 1) {
            const only = slides[0];
            const vid = only.querySelector('video');
            if (vid) {
                vid.currentTime = 0;
                vid.play().catch(()=>{/* autoplay blocked */});
            }
            return;
        }

        // Rotation function handles video durations
        function nextSlide() {
            const currentSlide = slides[currentMedia];
            const currentVid = currentSlide ? currentSlide.querySelector('video') : null;
            if (currentVid) {
                // pause video when leaving
                try { currentVid.pause(); currentVid.currentTime = 0; } catch(e){}
            }
            // move index
            slides[currentMedia].classList.remove('active');
            currentMedia = (currentMedia + 1) % slides.length;
            slides[currentMedia].classList.add('active');

            // If the new slide is video, play it and set timer to its duration (or fallback)
            const nextVid = slides[currentMedia].querySelector('video');
            if (nextVid) {
                const mediaInfo = dashboardData.media[currentMedia] || {};
                const duration = (mediaInfo.duration && Number(mediaInfo.duration)) || (dashboardData.settings.mediaRotationSpeed || 8);
                nextVid.currentTime = 0;
                nextVid.muted = true;
                nextVid.play().catch(()=>{/* autoplay blocked */});
                videoTimer = setTimeout(nextSlide, duration * 1000);
            }
        }

        // Start: if first is video -> play and set timeout; else set interval to settings speed
        const firstSlide = slides[currentMedia];
        const firstVid = firstSlide ? firstSlide.querySelector('video') : null;
        if (firstVid) {
            const duration = (dashboardData.media[currentMedia] && Number(dashboardData.media[currentMedia].duration)) || (dashboardData.settings.mediaRotationSpeed || 8);
            firstVid.muted = true;
            firstVid.currentTime = 0;
            firstVid.play().catch(()=>{/* autoplay blocked */});
            videoTimer = setTimeout(function autoNext(){ nextSlide(); }, duration * 1000);
            // Also set an interval fallback in case user wants interval behavior between videos
            mediaInterval = null;
        } else {
            // images: use setInterval based on settings
            const speed = (dashboardData.settings.mediaRotationSpeed || 8) * 1000;
            mediaInterval = setInterval(() => {
                const slidesNow = document.querySelectorAll('.media-slide');
                if (slidesNow.length <= 1) return;
                slidesNow[currentMedia].classList.remove('active');
                currentMedia = (currentMedia + 1) % slidesNow.length;
                slidesNow[currentMedia].classList.add('active');
            }, speed);
        }
    }

    // ANNOUNCEMENTS
    function renderAnnouncements() {
        const container = document.getElementById('announcement-container');
        container.innerHTML = '';
        const ann = Array.isArray(dashboardData.announcements) ? dashboardData.announcements : [];
        if (ann.length === 0) {
            container.innerHTML = '<div class="info-card good-announcement"><div class="card-title">Welcome to YMCA!</div><div class="card-subtitle">Have a great workout today</div></div>';
            return;
        }
        ann.forEach((a, idx) => {
            const div = document.createElement('div');
            const severity = a.severity || 'good';
            div.className = `announcement-slide ${severity}-announcement ${idx === 0 ? 'active' : ''}`;
            div.innerHTML = `<div class="card-title">${a.title || ''}</div><div class="card-subtitle">${a.message || ''}</div><div class="card-meta">${a.details || ''}</div>`;
            container.appendChild(div);
        });
    }

    function startAnnouncementRotation() {
        if (rotationInterval) clearInterval(rotationInterval);
        const slides = document.querySelectorAll('.announcement-slide');
        if (!slides || slides.length <= 1) return;
        currentAnnouncement = 0;
        const speed = (dashboardData.settings.rotationSpeed || 4) * 1000;
        rotationInterval = setInterval(() => {
            const slidesNow = document.querySelectorAll('.announcement-slide');
            if (slidesNow.length === 0) return;
            slidesNow[currentAnnouncement].classList.remove('active');
            currentAnnouncement = (currentAnnouncement + 1) % slidesNow.length;
            slidesNow[currentAnnouncement].classList.add('active');
        }, speed);
    }

    // CLASSES
    function renderClasses() {
        const container = document.getElementById('classes-container');
        container.innerHTML = '';
        const classes = Array.isArray(dashboardData.classes) ? dashboardData.classes : [];
        if (classes.length === 0) {
            container.innerHTML = '<div class="info-card"><div class="card-title">No classes scheduled for today</div></div>';
            return;
        }
        classes.forEach(c => {
            const card = document.createElement('div');
            card.className = c.cancelled ? 'info-card cancelled-class' : 'info-card';
            let inner = `<div class="card-title">${escapeHtml(c.name)}</div><div class="card-subtitle">${escapeHtml(c.time)} - ${escapeHtml(c.location || '')}</div><div class="card-meta">Instructor: ${escapeHtml(c.instructor || '')}</div>`;
            if (c.cancelled) inner += `<div class="cancelled-badge">CANCELLED</div>`;
            card.innerHTML = inner;
            container.appendChild(card);
        });
    }

    // ADMIN / TABLE RENDERS and actions
    function renderAdminTables() {
        // classes table
        const classesTbl = document.getElementById('classes-table');
        classesTbl.innerHTML = '';
        (dashboardData.classes || []).forEach(c => {
            const tr = document.createElement('tr');
            const statusBadge = c.cancelled ? '<span class="severity-badge severity-urgent">Cancelled</span>' : '<span class="severity-badge severity-good">Active</span>';
            const toggleBtn = `<button class="btn" style="background:#f59e0b;color:white;" onclick="toggleClassCancellation('${c.id}')">${c.cancelled ? 'Reactivate' : 'Cancel'}</button>`;
            const editBtn = c.fromSchedule ? '' : `<button class="btn btn-secondary" style="background:#059669;" onclick="editClass('${c.id}')">Edit</button>`;
            const deleteBtn = c.fromSchedule ? '' : `<button class="btn btn-danger" onclick="removeClass('${c.id}')">Delete</button>`;

            tr.innerHTML = `
                <td>${escapeHtml(c.name)}</td>
                <td>${escapeHtml(c.time)}</td>
                <td>${escapeHtml(c.location || '')}</td>
                <td>${escapeHtml(c.instructor || '')}</td>
                <td>${statusBadge}</td>
                <td>${toggleBtn} ${editBtn} ${deleteBtn}</td>
            `;
            classesTbl.appendChild(tr);
        });

        // announcements table
        const annTbl = document.getElementById('announcements-table');
        annTbl.innerHTML = '';
        (dashboardData.announcements || []).forEach(a => {
            const tr = document.createElement('tr');
            const deleteBtn = a.permanent ? '<span style="color:#6b7280;font-style:italic;">Permanent</span>' : `<button class="btn btn-danger" onclick="removeAnnouncement(${a.id})">Delete</button>`;
            tr.innerHTML = `<td>${escapeHtml(a.title || '')}</td><td>${escapeHtml(a.message || '')}</td><td><span class="severity-badge severity-${a.severity || 'good'}">${escapeHtml(a.severity || '')}</span></td><td>${deleteBtn}</td>`;
            annTbl.appendChild(tr);
        });

        // media table
        const mediaTbl = document.getElementById('media-table');
        mediaTbl.innerHTML = '';
        (dashboardData.media || []).forEach((m, i) => {
            const tr = document.createElement('tr');
            const deleteBtn = m.permanent ? '<span style="color:#6b7280;font-style:italic;">Permanent</span>' : `<button class="btn btn-danger" onclick="removeMedia(${i})">Delete</button>`;
            const srcShort = (m.src && m.src.length > 60) ? m.src.substring(0,60) + '...' : (m.src || '');
            tr.innerHTML = `<td><span class="severity-badge severity-good">${escapeHtml(m.type || 'image')}</span></td><td>${escapeHtml(srcShort)}</td><td>${deleteBtn}</td>`;
            mediaTbl.appendChild(tr);
        });
    }

    // ---------- ADMIN ACTIONS ----------
    function addMedia(e) {
        e.preventDefault();
        const url = document.getElementById('imageUrl').value.trim();
        const type = document.getElementById('mediaType').value;
        const durationVal = document.getElementById('mediaDuration').value;
        if (!url) return alert('Enter media URL');
        const item = { id: Date.now(), type, src: url, permanent: false };
        if (durationVal) item.duration = Number(durationVal);
        dashboardData.media.push(item);
        saveLocalData();
        renderMedia();
        renderAdminTables();
        startMediaRotation();
        showSuccess();
        clearMediaForm();
    }

    function removeMedia(index) {
        // index to remove (from dashboardData.media array)
        const item = dashboardData.media[index];
        if (!item) return;
        if (item.permanent) return alert('Cannot remove permanent media from admin table (edit JSON instead).');
        dashboardData.media.splice(index,1);
        saveLocalData();
        renderMedia();
        renderAdminTables();
        startMediaRotation();
        showSuccess();
    }

    function clearMediaForm() {
        document.getElementById('media-form').reset();
    }

    function addClass(e) {
        e.preventDefault();
        const name = document.getElementById('className').value.trim();
        const time = document.getElementById('classTime').value.trim();
        const location = document.getElementById('classLocation').value.trim();
        const instructor = document.getElementById('classInstructor').value.trim();
        const cancelled = document.getElementById('classCancelled').checked;
        if (!name) return alert('Enter class name');
        const newClass = { id: Date.now().toString(), name, time, location, instructor, cancelled, fromSchedule:false };
        dashboardData.classes.push(newClass);
        saveLocalData();
        renderClasses();
        renderAdminTables();
        clearClassForm();
        showSuccess();
    }

    function removeClass(id) {
        dashboardData.classes = dashboardData.classes.filter(c => c.id !== id);
        saveLocalData();
        renderClasses();
        renderAdminTables();
        showSuccess();
    }

    function toggleClassCancellation(id) {
        const c = dashboardData.classes.find(x => x.id === id);
        if (!c) return;
        c.cancelled = !c.cancelled;
        saveLocalData();
        renderClasses();
        renderAdminTables();
        showSuccess();
    }

    function editClass(id) {
        const c = dashboardData.classes.find(x => x.id === id);
        if (!c) return;
        document.getElementById('className').value = c.name;
        document.getElementById('classTime').value = c.time;
        document.getElementById('classLocation').value = c.location;
        document.getElementById('classInstructor').value = c.instructor;
        document.getElementById('classCancelled').checked = c.cancelled;
        const form = document.getElementById('class-form');
        form.onsubmit = function(ev) { updateClass(ev, id); };
        form.querySelector('button[type="submit"]').textContent = 'Update Class';
    }

    function updateClass(e, id) {
        e.preventDefault();
        const c = dashboardData.classes.find(x => x.id === id);
        if (!c) return;
        c.name = document.getElementById('className').value.trim();
        c.time = document.getElementById('classTime').value.trim();
        c.location = document.getElementById('classLocation').value.trim();
        c.instructor = document.getElementById('classInstructor').value.trim();
        c.cancelled = document.getElementById('classCancelled').checked;
        saveLocalData();
        renderClasses();
        renderAdminTables();
        clearClassForm();
        showSuccess();
    }

    function clearClassForm() {
        const form = document.getElementById('class-form');
        form.reset();
        form.onsubmit = addClass;
        form.querySelector('button[type="submit"]').textContent = 'Add Class';
    }

    function addAnnouncement(e) {
        e.preventDefault();
        const title = document.getElementById('announcementTitle').value.trim();
        const message = document.getElementById('announcementMessage').value.trim();
        const details = document.getElementById('announcementDetails').value.trim();
        const severity = document.getElementById('announcementSeverity').value;
        if (!title || !message) return alert('Title and message required');
        const ann = { id: Date.now(), title, message, details, severity, permanent:false };
        dashboardData.announcements.push(ann);
        saveLocalData();
        renderAnnouncements();
        renderAdminTables();
        clearAnnouncementForm();
        startAnnouncementRotation();
        showSuccess();
    }

    function removeAnnouncement(id) {
        const ann = dashboardData.announcements.find(a => a.id === id);
        if (!ann) return;
        if (ann.permanent) return alert('Cannot delete permanent announcement from admin (edit JSON instead).');
        dashboardData.announcements = dashboardData.announcements.filter(a => a.id !== id);
        saveLocalData();
        renderAnnouncements();
        renderAdminTables();
        startAnnouncementRotation();
        showSuccess();
    }

    function clearAnnouncementForm() { document.getElementById('announcement-form').reset(); }

    function saveSettings() {
        dashboardData.settings.gymName = document.getElementById('gymName').value || dashboardData.settings.gymName;
        dashboardData.settings.rotationSpeed = Number(document.getElementById('rotationSpeed').value) || dashboardData.settings.rotationSpeed;
        dashboardData.settings.mediaRotationSpeed = Number(document.getElementById('mediaRotationSpeed').value) || dashboardData.settings.mediaRotationSpeed;
        document.getElementById('gymNameDisplay').textContent = dashboardData.settings.gymName || 'YMCA of Saskatoon';
        saveLocalData();
        startAnnouncementRotation();
        startMediaRotation();
        showSuccess();
    }

    // ---------- Admin UI helpers ----------
    function toggleAdmin() {
        const panel = document.getElementById('adminPanel');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    }

    function switchTab(name) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const el = document.getElementById(name + '-section');
        if (el) el.classList.add('active');
    }

    function showSuccess() {
        const el = document.getElementById('success-message');
        if (!el) return;
        el.style.display = 'block';
        setTimeout(()=> el.style.display = 'none', 2500);
    }

    // ---------- UTIL ----------
    function escapeHtml(s) {
        if (!s && s !== 0) return '';
        return String(s).replace(/[&<>"'`=\/]/g, function (c) {
            return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
        });
    }

    // Expose a few functions globally so inline HTML onclicks work
    window.toggleAdmin = toggleAdmin;
    window.switchTab = switchTab;
    window.addMedia = addMedia;
    window.clearMediaForm = clearMediaForm;
    window.addClass = addClass;
    window.clearClassForm = clearClassForm;
    window.editClass = editClass;
    window.removeClass = removeClass;
    window.toggleClassCancellation = toggleClassCancellation;
    window.addAnnouncement = addAnnouncement;
    window.clearAnnouncementForm = clearAnnouncementForm;
    window.removeAnnouncement = removeAnnouncement;
    window.saveSettings = saveSettings;
    window.resetData = resetData;
    window.removeMedia = removeMedia;

    // ---------- INITIAL render call after JSON load (called from initDashboard) ----------
    // Note: renderAll() is called from initDashboard after JSON load

    </script>
</body>
</html>
